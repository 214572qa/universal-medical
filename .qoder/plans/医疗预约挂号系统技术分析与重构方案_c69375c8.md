# 医疗预约挂号系统技术分析与重构方案

---

## 一、项目结构分析

### 1.1 目录结构概览

```
src/
├── api/                    # API 接口层
│   ├── home/              # 首页相关接口
│   ├── hospital/          # 医院/挂号相关接口
│   └── user/              # 用户相关接口
├── assets/                # 静态资源
├── components/            # 公共组件
│   ├── countdown/         # 倒计时组件
│   ├── hospital_bottom/   # 医院底部组件
│   ├── hospital_top/      # 医院头部组件
│   ├── login/             # 登录弹窗组件
│   └── visitor/           # 就诊人组件
├── pages/                 # 页面组件
│   ├── home/              # 首页模块
│   ├── hospital/          # 医院详情模块
│   ├── user/              # 用户中心模块
│   └── wxlogin/           # 微信登录回调
├── router/                # 路由配置
├── store/                 # Pinia 状态管理
│   └── modules/           # 状态模块
├── style/                 # 全局样式
├── utils/                 # 工具函数
└── permisstion.ts         # 路由权限控制
```

### 1.2 核心模块职责

| 模块 | 职责 | 关键文件 |
|------|------|----------|
| API层 | 封装HTTP请求、定义接口类型 | `api/hospital/index.ts`, `api/user/index.ts` |
| 状态管理 | 用户信息、医院详情的全局状态 | `store/modules/user.ts`, `store/modules/hospitalDetail.ts` |
| 路由系统 | 页面导航、嵌套路由、权限控制 | `router/index.ts`, `permisstion.ts` |
| 组件层 | 可复用UI组件 | `components/login/index.vue`, `components/visitor/visitor.vue` |

### 1.3 组件层级关系

```
App.vue
├── HospitalTop (全局头部)
├── HospitalBottom (全局底部)
├── Login (登录弹窗 - 全局)
└── RouterView
    ├── Home (首页)
    │   ├── Carousel
    │   ├── Search
    │   ├── Level
    │   ├── Region
    │   ├── Card
    │   └── Tip
    ├── Hospital (医院详情)
    │   ├── Register (预约挂号)
    │   │   ├── register_step1
    │   │   └── register_step2
    │   ├── Detail
    │   ├── Notice
    │   ├── Close
    │   └── Search
    └── User (用户中心)
        ├── Certification
        ├── Profile
        ├── Order
        │   ├── AllOrder
        │   └── Detail
        └── Patient
```

---

## 二、技术栈评估

### 2.1 依赖版本分析

| 技术 | 版本 | 评估 |
|------|------|------|
| Vue | ^3.5.24 | 最新稳定版，支持 Composition API |
| TypeScript | ~5.9.3 | 最新版本，类型安全保障 |
| Vite | ^7.2.4 | 高性能构建工具 |
| Pinia | ^3.0.4 | Vue 3 官方状态管理 |
| Element Plus | ^2.13.0 | 成熟的 UI 组件库 |
| Axios | ^1.13.2 | HTTP 客户端 |
| Vue Router | ^4.6.4 | 官方路由方案 |

### 2.2 技术使用情况评估

**优点：**
- 采用 Vue 3 Composition API，代码组织清晰
- TypeScript 类型定义较为完善 (`api/*/type.ts`)
- Pinia 状态管理模式规范
- Axios 二次封装包含请求/响应拦截器
- Vite + Mock 实现前端独立开发

**不足：**
- 部分组件仍使用 Options API 风格的响应式声明
- 类型定义存在重复（`ResponseData` 在多处定义）
- 缺少统一的错误处理机制
- 组件间通信方式不统一

### 2.3 Vite 配置分析

```typescript
// vite.config.ts 关键配置
- 路径别名：@ → src
- Mock 服务：开发环境自动启用
- 代理配置：已注释（需后端集成时启用）
```

---

## 三、核心业务流程提取

### 3.1 用户注册登录流程

```
用户点击登录 → 显示登录弹窗(Login组件)
    ├── 手机号登录
    │   ├── 输入手机号 → 校验格式(正则)
    │   ├── 获取验证码 → reqCode API → 倒计时60秒
    │   └── 提交登录 → reqUserLogin → 存储token到localStorage
    └── 微信扫码登录
        ├── 生成二维码 → 第三方API生成
        ├── 轮询检测登录状态 → queryState(1秒轮询localStorage)
        └── 登录成功 → 存储用户信息
```

**关键代码位置：**
- 登录组件：`src/components/login/index.vue`
- 用户Store：`src/store/modules/user.ts`
- Token工具：`src/utils/user.ts`

### 3.2 医院信息展示流程

```
首页加载 → reqHospitalList(分页) → 展示医院卡片列表
    ├── 等级筛选 → Level组件 → hostype参数
    ├── 地区筛选 → Region组件 → districtCode参数
    ├── 搜索功能 → Search组件 → reqHospitalInfo
    └── 分页切换 → Pagination → 重新请求

医院详情页 → reqHospitalDetail(hoscode) → 展示医院信息
    └── 存储到Pinia → hospitalDetail Store
```

### 3.3 科室选择流程

```
进入预约挂号 → reqHospitalDepartment(hoscode)
    └── 返回树形结构数据 → Deparment[]
        ├── 一级科室（内科、外科...）
        └── 二级科室（神经内科、消化内科...）
选择科室 → 携带hoscode + depcode跳转
```

### 3.4 医生排班查询流程

```
register_step1.vue:
加载排班数据 → reqHospitalWork(page, limit, hoscode, depcode)
    ├── 返回30天排班日期列表(bookingScheduleList)
    ├── 返回基础信息(baseMap: 医院名、科室名)
    └── 状态：-1停止挂号 | 0有号/约满 | 1即将放号

选择日期 → reqHospitalDoctor(hoscode, depcode, workDate)
    └── 返回医生列表(DocArr)
        ├── workTime: 0上午 | 1下午
        ├── availableNumber: 剩余号源
        └── amount: 挂号费用
```

### 3.5 预约挂号流程

```
register_step2.vue:
加载就诊人 → reqGetUser() → 展示就诊人卡片
加载医生信息 → reqDoctorInfo(docId) → 展示挂号信息

选择就诊人 → currentIndex
确认挂号 → reqSubmitOrder(hoscode, scheduleId, patientId)
    ├── 成功 → 返回orderId → 跳转订单详情
    └── 失败 → ElMessage提示
```

### 3.6 订单管理流程

```
订单列表(AllOrder):
加载订单 → reqUserOrderInfo(page, limit, patientId, orderStatus)
筛选功能:
    ├── 按就诊人筛选 → patientId
    └── 按状态筛选 → orderStatus

订单详情(Detail):
加载详情 → reqOrderInfo(orderId)
支付功能 → reqQrCode(orderId) → 生成支付二维码
取消订单 → reqCancelOrder(orderId)
```

---

## 四、代码质量审查

### 4.1 潜在Bug和逻辑错误

| 问题 | 位置 | 描述 | 风险等级 |
|------|------|------|----------|
| 定时器未清理 | `store/modules/user.ts:63-72` | `queryState`中定时器在组件销毁时未清理，可能导致内存泄漏 | 高 |
| 类型断言过多 | `components/login/index.vue:136` | `form = ref<any>()`缺少具体类型 | 中 |
| 空值处理不足 | `register_step2.vue:134` | `userArr.value[currentIndex.value]?.id`可能为undefined | 中 |
| 硬编码问题 | `register_step1.vue:37` | 放号时间写死为"2033年6月6日08:30" | 低 |
| watch深度监听 | `patient/index.vue:252` | `deep: true`对大数组性能影响 | 中 |

### 4.2 性能瓶颈

1. **重复请求问题**
   - `register_step1.vue`: 切换日期时`getDoctorData`无防抖
   - `home/index.vue`: watch监听4个变量，任一变化都触发请求

2. **大数据渲染**
   - 首页医院列表无虚拟滚动，大量数据时卡顿
   - 订单列表无分页懒加载

3. **状态管理**
   - `hospitalDetail` Store每次进入医院页都重新请求
   - 缺少数据缓存策略

### 4.3 安全风险

| 风险 | 描述 | 建议 |
|------|------|------|
| Token存储 | localStorage明文存储用户信息 | 建议加密或使用httpOnly cookie |
| 输入验证 | 前端验证可被绕过 | 后端必须二次验证 |
| XSS风险 | `innerHTML`直接插入二维码HTML | 使用安全的DOM操作 |
| 敏感信息 | 身份证号明文传输展示 | 传输加密+脱敏展示 |

### 4.4 代码规范问题

- 变量命名不统一：`hasHospitalArr` vs `userArr`
- 注释语言混用：中英文混杂
- 类型定义重复：`ResponseData`在3个文件中定义
- 组件命名：部分使用PascalCase，部分使用kebab-case

---

## 五、重构优化方案

### 5.1 架构优化建议

#### 5.1.1 API层重构

```typescript
// 建议：统一ResponseData定义
// src/api/types/common.ts
export interface ResponseData<T = any> {
  code: number;
  message: string;
  ok: boolean;
  data: T;
}

// 建议：API错误统一处理
// src/api/interceptors/errorHandler.ts
export const handleApiError = (error: AxiosError) => {
  const errorMap = {
    401: { message: 'Token过期', action: () => router.push('/login') },
    403: { message: '无权限访问', action: null },
    404: { message: '资源不存在', action: null },
    500: { message: '服务器错误', action: null },
  };
  // 统一处理逻辑
};
```

#### 5.1.2 状态管理优化

```typescript
// 建议：添加数据缓存
// src/store/modules/hospitalDetail.ts
const useDetailStore = defineStore('Detail', {
  state: () => ({
    hospitalInfo: {} as HosPitalDetail,
    deparmentArr: [] as DeparmentArr,
    lastFetchTime: 0, // 添加缓存时间戳
  }),
  actions: {
    async getHospital(hoscode: string, force = false) {
      const CACHE_TIME = 5 * 60 * 1000; // 5分钟缓存
      if (!force && Date.now() - this.lastFetchTime < CACHE_TIME) {
        return; // 使用缓存
      }
      // 请求逻辑...
    }
  }
});
```

#### 5.1.3 组件解耦

```
建议重构目录结构：
src/
├── composables/           # 组合式函数(新增)
│   ├── useAuth.ts        # 认证相关逻辑
│   ├── useHospital.ts    # 医院相关逻辑
│   └── useOrder.ts       # 订单相关逻辑
├── hooks/                 # 通用hooks(新增)
│   ├── useDebounce.ts
│   ├── useThrottle.ts
│   └── useRequest.ts
└── types/                 # 全局类型定义(新增)
    ├── common.ts
    ├── hospital.ts
    └── user.ts
```

### 5.2 代码重构计划

#### 阶段一：基础设施（1-2天）
1. 统一类型定义，消除重复
2. 封装useRequest Hook处理请求状态
3. 添加全局错误边界组件

#### 阶段二：组件优化（2-3天）
1. 登录组件拆分（手机登录/微信登录）
2. 就诊人组件抽象为通用选择器
3. 表单验证规则统一管理

#### 阶段三：性能优化（1-2天）
1. 添加请求防抖/节流
2. 实现数据缓存策略
3. 大列表虚拟滚动

### 5.3 性能提升措施

```typescript
// 1. 请求防抖
// src/hooks/useDebounce.ts
export function useDebouncedRequest<T>(
  fn: () => Promise<T>,
  delay = 300
) {
  const loading = ref(false);
  const debouncedFn = useDebounceFn(async () => {
    loading.value = true;
    try {
      return await fn();
    } finally {
      loading.value = false;
    }
  }, delay);
  return { execute: debouncedFn, loading };
}

// 2. 路由懒加载（已实现）+ 预加载
// src/router/index.ts
const Register = () => import('@/pages/hospital/register/index.vue');

// 3. 组件懒加载
const AsyncVisitor = defineAsyncComponent(() => 
  import('@/components/visitor/visitor.vue')
);
```

### 5.4 安全加固策略

```typescript
// 1. Token加密存储
// src/utils/user.ts
import CryptoJS from 'crypto-js';

const SECRET_KEY = import.meta.env.VITE_SECRET_KEY;

export const SET_TOKEN = (userInfo: object) => {
  const encrypted = CryptoJS.AES.encrypt(
    JSON.stringify(userInfo),
    SECRET_KEY
  ).toString();
  localStorage.setItem('USERINFO', encrypted);
};

// 2. 敏感信息脱敏
export const maskIdCard = (idCard: string) => {
  return idCard.replace(/^(.{6})(.*)(.{4})$/, '$1****$3');
};

// 3. XSS防护
// 使用DOMPurify清理HTML
import DOMPurify from 'dompurify';
const safeHTML = DOMPurify.sanitize(untrustedHTML);
```

---

## 六、后端集成规划

### 6.1 接口规范设计

```typescript
// RESTful API 规范
GET    /api/v1/hospitals                    # 医院列表
GET    /api/v1/hospitals/:hoscode           # 医院详情
GET    /api/v1/hospitals/:hoscode/departments  # 科室列表
GET    /api/v1/schedules                    # 排班查询
POST   /api/v1/orders                       # 创建订单
GET    /api/v1/orders/:orderId              # 订单详情
PUT    /api/v1/orders/:orderId/cancel       # 取消订单

// 响应格式统一
{
  "code": 200,
  "message": "success",
  "data": { ... },
  "timestamp": 1676123456789
}
```

### 6.2 数据库模型设计

```sql
-- 核心表结构
hospitals (医院表)
├── id, hoscode, hosname, hostype
├── province_code, city_code, district_code
├── logo_data, intro, route, status
└── booking_rule (JSON)

departments (科室表)
├── id, hoscode, depcode, depname
├── parent_id (支持树形结构)
└── status

schedules (排班表)
├── id, hoscode, depcode, work_date
├── doctor_id, work_time (0上午/1下午)
├── reserved_number, available_number
└── amount, status

orders (订单表)
├── id, user_id, hoscode, schedule_id
├── patient_id, order_status
├── amount, create_time
└── payment_info (JSON)

patients (就诊人表)
├── id, user_id, name, certificates_type
├── certificates_no, phone, sex
└── address, contacts_info (JSON)
```

### 6.3 前端对接方案

```typescript
// vite.config.ts 代理配置
server: {
  proxy: {
    '/api': {
      target: process.env.VITE_API_BASE_URL || 'http://localhost:8080',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api/, '')
    }
  }
}

// 环境变量配置
// .env.development
VITE_API_BASE_URL=http://localhost:8080
VITE_MOCK_ENABLED=true

// .env.production
VITE_API_BASE_URL=https://api.hospital.com
VITE_MOCK_ENABLED=false
```

### 6.4 版本管理策略

```
API版本管理：
/api/v1/*  - 当前稳定版本
/api/v2/*  - 新功能版本（向后兼容）

前端适配：
- 使用适配器模式处理多版本API
- 通过Feature Flag控制新功能
```

---

## 七、实施路线图

### 第一阶段：基础重构（Week 1-2）
- [ ] 统一类型定义系统
- [ ] 重构API层错误处理
- [ ] 封装通用Hooks
- [ ] 修复已识别Bug

### 第二阶段：性能优化（Week 3）
- [ ] 实现请求缓存机制
- [ ] 添加防抖节流
- [ ] 优化大列表渲染
- [ ] 路由预加载

### 第三阶段：安全加固（Week 4）
- [ ] Token加密存储
- [ ] 敏感信息脱敏
- [ ] XSS防护加固
- [ ] 权限系统完善

### 第四阶段：后端集成（Week 5-6）
- [ ] 对接真实API
- [ ] 移除Mock服务
- [ ] 联调测试
- [ ] 性能压测

---

## 八、技术架构图

```
┌─────────────────────────────────────────────────────────┐
│                      前端架构                            │
├─────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │
│  │  Pages  │  │Components│  │ Router  │  │  Store  │    │
│  │ (页面)  │  │ (组件)   │  │ (路由)  │  │ (Pinia) │    │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘    │
│       │            │            │            │          │
│       └────────────┴────────────┴────────────┘          │
│                         │                               │
│  ┌──────────────────────┴────────────────────────────┐  │
│  │                    Composables                    │  │
│  │     (useAuth, useHospital, useOrder, etc.)       │  │
│  └──────────────────────┬────────────────────────────┘  │
│                         │                               │
│  ┌──────────────────────┴────────────────────────────┐  │
│  │                    API Layer                      │  │
│  │  (Axios + Interceptors + Error Handler)          │  │
│  └──────────────────────┬────────────────────────────┘  │
├─────────────────────────┼───────────────────────────────┤
│                         ▼                               │
│  ┌──────────────────────────────────────────────────┐  │
│  │              Backend API (RESTful)               │  │
│  │    Spring Boot / Node.js + MySQL / PostgreSQL    │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 九、关键改进文件清单

| 文件 | 改进内容 | 优先级 |
|------|----------|--------|
| `src/api/types/common.ts` | 新建-统一类型定义 | P0 |
| `src/utils/request.ts` | 重构-错误处理优化 | P0 |
| `src/store/modules/user.ts` | 修复-定时器清理 | P0 |
| `src/composables/useRequest.ts` | 新建-请求Hook | P1 |
| `src/components/login/index.vue` | 重构-组件拆分 | P1 |
| `src/pages/hospital/register/register_step1.vue` | 优化-防抖处理 | P1 |
| `src/utils/user.ts` | 增强-Token加密 | P2 |
| `src/pages/home/index.vue` | 优化-请求合并 | P2 |
